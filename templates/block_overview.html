{% extends "base.html" %}

{% load i18n %}
{% load humanize %}
{% load btc_formats %}

{% block content %}

<div class="bg-primary section page-header">
  <div class="container">
    <h1>
      <i class="fa fa-cube"></i> 
      {{ coin_symbol|coin_symbol_to_display_name }} Block {{ block_details.height|intcomma }}
    </h1>
    <h2 class="tagline truncate">({{ block_details.hash }})</h2>
  </div>
</div>

<div class="container">
  <nav>
    <a href="{% url 'block_overview' coin_symbol block_details.prev_block %}" class="btn btn-default pull-left">
      <i class="fa fa-angle-double-left"></i> 
      Previous Block
    </a>
    <a href="#{# FIXME: Should link somewhere #}" class="btn btn-default pull-right">
      Next Block 
      <i class="fa fa-angle-double-right"></i>
    </a>
    <div class="clearfix"></div>
  </nav>
</div>

<div class="section">
  <div class="container">
    <div class="dash">
      <ul>
        <li>
          <span class="dash-label">Recieved</span><br>
          {{ block_details.received_time|naturaltime }}
        </li>
        <li>
          <span class="dash-label">Num Transactions</span><br>
          {{ block_details.n_tx }}
        </li>
        <li>
          <span class="dash-label">Total Transacted</span><br>
          {{ block_details.total|satoshis_to_btc_rounded }} {{ coin_symbol|coin_symbol_to_currency_name }}
        </li>
        <li>
          <span class="dash-label">Total Fees</span><br>
          {{ block_details.fees|satoshis_to_btc_rounded }} {{ coin_symbol|coin_symbol_to_currency_name }}
        </li>
      </ul>
      <div class="clearfix"></div>
    </div>
  </div>
</div>

<div class="section">
  <div class="container">

    <p class="text-center">
      <button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#advanced-details">
        Advanced details 
        <b class="caret"></b>
      </button>
    </p>

    <div class="col-md-12 collapse" id="advanced-details">
      <div class="table-responsive">
        <table class="table">
          <tr>
            <th>Nonce</th>
            <td>
              {{ block_details.nonce }}
            </td>
          </tr>
          <tr>
            <th>Merkle Root</th>
            <td>
              {{ block_details.mrkl_root }}
            </td>
          </tr>
          <tr>
            <th>Bits (difficulty target)</th>
            <td>
              {{ block_details.bits }}
            </td>
          </tr>
          <tr>
            <th>Version</th>
            <td>
              {{ block_details.ver }}
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="container">

<h2>{{ block_details.n_tx }} Transactions</h2>

{% if block_details.txids %}

  {% if current_page > 1 %}
    {# There are transactions from a previous page that are not displayed on this page #}
    <p>...</p>
    <br />
  {% endif %}

  {% for transaction in block_details.txids %}

    <p><a href="{% url 'transaction_overview' coin_symbol transaction.hash %}">{{ transaction.hash }}</a></p>

    <div class="table-responsive">
      <table class="table table-bordered">
        <th>Inputs Consumed ({{ transaction.vin_sz }})</th>
        <th>Outputs Created ({{ transaction.vout_sz }})</th>
        <tr>
          <td>
            {% for input in transaction.inputs %}
              {{ input.output_value|satoshis_to_btc_rounded }}
              {{ coin_symbol|coin_symbol_to_currency_name }}
              {% if input.addresses|length == 0 %}
                {# the coinbase! #}
                from Block Reward
              {% else %}
                from <a href="{% url 'address_overview' coin_symbol input.addresses.0 %}">{{ input.addresses.0 }}</a>
              {% endif %}
              <br />
            {% endfor %}
            {% if inputs|length < transaction.vin_sz %}...{% endif %}
          </td>
          <td>
            {% for output in transaction.outputs %}
              {{ output.value|satoshis_to_btc_rounded }} {{ coin_symbol|coin_symbol_to_currency_name }}
              to <a href="{% url 'address_overview' coin_symbol output.addresses.0 %}">{{ output.addresses.0 }}</a>
              {% if output.spent_by %}
                (<a href="{% url 'transaction_overview' coin_symbol output.spent_by %}">spent</a>)
              {% else %}
                (unspent)
              {% endif %}
              <br />
            {% endfor %}
            {% if outputs|length < transaction.vout_sz %}...{% endif %}
          </td>
        </tr>
      </table>
    </div>

  {% endfor %}

  {% if current_page < max_pages %}
    {# There are more transactions than are displayed on this page #}
    <p>...</p>
    <br />
  {% endif %}

  <div class="pagination">
    <span class="step-links">
      {% if current_page > 1 %}
        <a href="?page={{ current_page|add:-1 }}">Previous</a>.
      {% endif %}

      <span class="current">
        Page {{ current_page }} of {{ max_pages }}.
      </span>

      {% if current_page < max_pages %}
        <a href="?page={{ current_page|add:1 }}">Next</a>.
      {% endif %}
    </span>
  </div>

{% else %}
  <p>In rare cases it is possible for a block to be empty. <a href="#">More info</a>.</p>
{% endif %}

<p>API Call: <a href="{{ api_url }}">{{ api_url }}</a></p>

</div>

{% endblock content %}

