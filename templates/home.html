{% extends "base.html" %}

{% block content %}
{% load i18n %}

<div class="bg-primary-gradient">
  <div class="container">

  <!--   <form role="form" method="post" action="{% url "home" %}">
      {% load crispy_forms_tags %}
      {{ form|crispy }}
      {% csrf_token %}
      <p class="text-center">
        <button type="submit" class="btn btn-primary btn-lg">{% trans "Search" %} </button>
      </p>
    </form> -->

    <div class="row">
      <div class="col-lg-8 col-lg-offset-2">

        <h1>Important title here</h1>
        <p class="lead">Nunc Eu Ullamcorper Orci. Quisque Eget Odio Ac Lectus Vestibulum</p>

        <form role="form" method="post" action="{% url "home" %}">
          {% csrf_token %}
          <div class="input-group input-group-lg">
            <div class="input-group-btn">
              <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">Currency <span class="caret"></span></button>
              <ul class="dropdown-menu" role="menu">
                <li><a href="#">Bitcoin</a></li>
                <li><a href="#">Bitcoin Testnet</a></li>
                <li><a href="#">Litecoin</a></li>
                <li><a href="#">URO</a></li>
                <li><a href="#">Blockcypher Testnet</a></li>
              </ul>
            </div><!-- /btn-group -->
            <input type="text" class="form-control" placeholder="Enter an address, transaction hash, block hash, or block number">
          </div><!-- /input-group -->

          <p class="text-center">
            <button type="submit" class="btn btn-primary btn-lg" style="margin:30px 0;">
              <i class="fa fa-search"></i> 
              {% trans "Search" %}
            </button>
          </p>

        </form>
      </div>
    </div>
  </div>
</div>

<div class="bg-white">
  <div class="container">

    <div class="row text-center">
      <h2>Explore Latest blocks</h2>
      <div class="col-lg-10 col-md-offset-1">
        <ul class="block-currency-logos">
          <li>
            <a href="{% url 'latest_block' 'btc' %}" class="btc">
              <span>Bitcoin</span>
            </a>
          </li>
          <li>
            <a href="{% url 'latest_block' 'btc-testnet' %}" class="btc">
              <span>Bitcoin Testnet</span>
            </a>
          </li>
          <li>
            <a href="{% url 'latest_block' 'ltc' %}" class="ltc">
              <span>Litecoin</span>
            </a>
          </li>
          <li>
            <a href="{% url 'latest_block' 'uro' %}" class="btc">
              <span>URO</span>
            </a>
          </li>
          <li>
            <a href="{% url 'latest_block' 'bcy' %}" class="btc">
              <span>Blockcypher Testnet</span>
            </a>
          </li>
        </ul>
      </div>
    </div>

  <!--   <p>
    Bored? Check out current block on the
    <a href="{% url 'latest_block' 'btc' %}">Bitcoin</a>,
    <a href="{% url 'latest_block' 'btc-testnet' %}">Bitcoin Testnet</a>,
    <a href="{% url 'latest_block' 'ltc' %}">Litecoin</a>,
    <a href="{% url 'latest_block' 'uro' %}">URO</a>, or
    <a href="{% url 'latest_block' 'bcy' %}">Blockcypher Testnet</a>
    networks.
    </p> -->

  <!-- <div id="newtx-section" style="display:none">
      <h4>Latest Transactions</h4>

      <table class="table table-striped">
        <tr id="latest-txs">
          <th>Transaction Hash</th>
          <th>BTC</th>
          <th>Time</th>
        </tr>
        <tr class="new-tx" style="display;none"></tr>
      </table>

      <br />
      <p>
      Note: Blockypher is a lot faster than other blockchain APIs, so these transactions may take a bit to appear on other sites.
      </p>
    </div> -->

  </div>
</div>
{% endblock content %}

{% block extra_js %}
  <script>

    function satoshis_to_btc(satoshis) {
      // Round to 4 decimal places
      var btc = satoshis/(Math.pow(10,8));
      return Math.round(btc*10000)/10000;
    }

    function convert_time_to_seconds_ago(epoch) {
      return (Date.now() - Date.parse(epoch))/1000;
    }

    function format_seconds_ago(seconds_ago) {
      if( seconds_ago < 60) {
        return  '<1 min ago';
      } else if (seconds_ago < 120) {
        return '<2 mins ago';
      } else if (seconds_ago < 180) {
        return '<3 mins ago';
      } else if (seconds_ago < 240) {
        return '<4 mins ago';
      } else if (seconds_ago < 300) {
        return '<5 mins ago';
      } else if (seconds_ago < 600) {
        return '<10 mins ago';
      } else {
        return '>5 minutes ago';
      }
    }

    $(document).ready(function(){

      console.log('Creating webshocket...');
      var ws = new WebSocket("ws://socket.blockcypher.com/v1/btc/main");
      console.log('Webshocket created');

      var total_ws_received = 0;

      ws.onmessage = function(evt) {
        total_ws_received += 1;
        var tx = JSON.parse(evt.data);

        if ( $('#' + tx.hash).length == 0 ) {
          $('#newtx-section').fadeIn(); // only matters the first time
          var btc_rounded = satoshis_to_btc(tx.total);
          var seconds_ago = convert_time_to_seconds_ago(tx.received)
          var time_ago_formatted = format_seconds_ago(seconds_ago);

          to_insert = '<tr class="new-tx" id="'+tx.hash+'"><td><a href="/btc/tx/'+tx.hash+'">'+tx.hash.substring(0,12)+'</a>...</td><td>'+btc_rounded+' BTC</td><td class="timing" received="'+tx.received+'">'+time_ago_formatted+'</td></tr>';
          $('.new-tx').first().before(to_insert);
          // New row effect:
          $('.new-tx').first().hide().fadeIn();

          if ( $('.new-tx').length > 10 ) {
            // Trim end of list once long
            $('.new-tx').last().fadeOut().remove();
          }

          if (total_ws_received > 10000) {
            ws.close();
          }

          var times_array = $('.timing');
          var times_length = times_array.length;
          for (var i = 0; i < times_length; i++) {
            times_array[i].innerHTML = format_seconds_ago(convert_time_to_seconds_ago(times_array[i].getAttribute('received')));
          }


        }
      }

      console.log('Setting websocket event...');
      setInterval(function() { ws.send(JSON.stringify({event: "unconfirmed-tx"})) }, 3000);
      console.log('Websocket event set');

    })

  </script>
{% endblock extra_js %}
